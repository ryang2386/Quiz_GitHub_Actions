name: Render Deploy

on:
  pull_request:
  push:
    branches: [main]

jobs:
  render-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Test
        run: |
          npm install
          npm run build
          npm run start & sleep 10
          npx cypress run --component

      - name: Write Detailed Cypress Test Summary
        run: |
            echo "## Cypress Test Results" >> $GITHUB_STEP_SUMMARY

            if [ ! -f cypress/results/results.xml ]; then
              echo "Results file not found!"
              exit 1
              fi

    
              xmllint --xpath "//testcase" cypress/results/results.xml | \
              sed -E 's/<testcase /\n<testcase /g' | \
              while read -r testcase; do
                name=$(echo "$testcase" | grep -oP 'name="\K[^"]+')
                time=$(echo "$testcase" | grep -oP 'time="\K[^"]+')

              if echo "$testcase" | grep -q "<skipped"; then
                status="Skipped 🔁"
                passed=""
                failed=""
                pending=""
                skipped="1"
              elif echo "$testcase" | grep -q "<failure"; then
                status="Failed ❌"
                passed=""
                failed="1"
                pending=""
                skipped=""
              elif echo "$testcase" | grep -q "<error"; then
                status="Error 💥"
                passed=""
                failed="1"
                pending=""
                skipped=""
              else
                status="Passed ✅"
                passed="1"
                failed=""
                pending=""
                skipped=""
                fi

              echo "### $name" >> $GITHUB_STEP_SUMMARY
              echo "| Result | Passed ✅ | Failed ❌ | Pending 🖐️ | Skipped 🔁 | Duration ⏱️ |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|-----------|-----------|-------------|-------------|--------------|" >> $GITHUB_STEP_SUMMARY
              echo "| $status | ${passed:-0} | ${failed:-0} | ${pending:-0} | ${skipped:-0} | ${time}s |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              done

      - name: Publish test results
        uses: dorny/test-reporter@v2
        with:
            name: Cypress Component Tests
            path: cypress/results/*.xml
            reporter: java-junit
            fail-on-error: true

      - name: Deploy
        # Only run this step if the branch is main
        if: github.ref == 'refs/heads/main'
        env:
          deploy_url: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          curl "$deploy_url"